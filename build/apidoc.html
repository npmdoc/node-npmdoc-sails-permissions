<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="https://github.com/tjwebb/sails-permissions"

    >sails-permissions (v2.2.0)</a>
</h1>
<h4>Comprehensive user permissions and entitlements system for sails.js and Waterline. Supports user authentication with passport.js, role-based permissioning, object ownership, and row-level security.</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.sails-permissions">module sails-permissions</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.sails-permissions">
            function <span class="apidocSignatureSpan"></span>sails-permissions
            <span class="apidocSignatureSpan">(sails)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sails-permissions.</span>Passport</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sails-permissions.</span>PermissionService</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sails-permissions.</span>User</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sails-permissions.</span>generator</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.sails-permissions.Passport">module sails-permissions.Passport</a><ol>

        <li>

            <span class="apidocSignatureSpan">boolean <span class="apidocSignatureSpan">sails-permissions.Passport.</span>autoCreatedBy</span>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.Passport.beforeCreate">
            function <span class="apidocSignatureSpan">sails-permissions.Passport.</span>beforeCreate
            <span class="apidocSignatureSpan">(passport, next)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.Passport.beforeUpdate">
            function <span class="apidocSignatureSpan">sails-permissions.Passport.</span>beforeUpdate
            <span class="apidocSignatureSpan">(passport, next)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sails-permissions.Passport.</span>attributes</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.sails-permissions.PermissionService">module sails-permissions.PermissionService</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.addUsersToRole">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>addUsersToRole
            <span class="apidocSignatureSpan">(usernames, rolename)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.createRole">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>createRole
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.findModelPermissions">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>findModelPermissions
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.findTargetObjects">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>findTargetObjects
            <span class="apidocSignatureSpan">(req)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.getErrorMessage">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>getErrorMessage
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.getMethod">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>getMethod
            <span class="apidocSignatureSpan">(method)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.grant">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>grant
            <span class="apidocSignatureSpan">(permissions)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.hasForeignObjects">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>hasForeignObjects
            <span class="apidocSignatureSpan">(objects, user)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.hasOwnershipPolicy">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>hasOwnershipPolicy
            <span class="apidocSignatureSpan">(model)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.hasPassingCriteria">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>hasPassingCriteria
            <span class="apidocSignatureSpan">(objects, permissions, attributes, user)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.hasUnpermittedAttributes">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>hasUnpermittedAttributes
            <span class="apidocSignatureSpan">(attributes, blacklist)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.isAllowedToPerformAction">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>isAllowedToPerformAction
            <span class="apidocSignatureSpan">(objects, user, action, model, body)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.isAllowedToPerformSingle">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>isAllowedToPerformSingle
            <span class="apidocSignatureSpan">(user, action, model, body)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.isForeignObject">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>isForeignObject
            <span class="apidocSignatureSpan">(owner)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.removeUsersFromRole">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>removeUsersFromRole
            <span class="apidocSignatureSpan">(usernames, rolename)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.PermissionService.revoke">
            function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>revoke
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.sails-permissions.User">module sails-permissions.User</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.User.beforeCreate">
            function <span class="apidocSignatureSpan">sails-permissions.User.</span>beforeCreate
            <span class="apidocSignatureSpan">(user, next)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.User.register">
            function <span class="apidocSignatureSpan">sails-permissions.User.</span>register
            <span class="apidocSignatureSpan">(user)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sails-permissions.User.</span>afterCreate</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sails-permissions.User.</span>attributes</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.sails-permissions.generator">module sails-permissions.generator</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sails-permissions.generator.before">
            function <span class="apidocSignatureSpan">sails-permissions.generator.</span>before
            <span class="apidocSignatureSpan">(scope, next)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sails-permissions.generator.</span>targets</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">string <span class="apidocSignatureSpan">sails-permissions.generator.</span>templatesDirectory</span>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sails-permissions" id="apidoc.module.sails-permissions">module sails-permissions</a></h1>


    <h2>
        <a href="#apidoc.element.sails-permissions.sails-permissions" id="apidoc.element.sails-permissions.sails-permissions">
        function <span class="apidocSignatureSpan"></span>sails-permissions
        <span class="apidocSignatureSpan">(sails)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">sails-permissions = function (sails) {
  var hook = new Hook(sails);
  hook.loadConfig(Hook.constructor.name);

  var config = _lodash2[&#x27;default&#x27;].defaults({}, Marlinspike.defaultConfig());
  if (hook.name in sails.config) _lodash2[&#x27;default&#x27;].extend(config.marlinspike, sails.config[hook.name].marlinspike);

  return {
    name: _this.name,
    routes: hook.routes(),
    defaults: function defaults(overrides) {
      return _lodash2[&#x27;default&#x27;].merge(config, hook.defaults(overrides));
    },
    configure: function configure() {
      if (config.marlinspike.services) hook.loadServices();
      if (config.marlinspike.models) hook.loadModels();
      if (config.marlinspike.controllers) hook.loadControllers();
      if (config.marlinspike.policies) hook.loadPolicies();

      hook.configure();
      sails.emit(&#x27;hook:&#x27; + hook.name + &#x27;:configured&#x27;);
    },
    initialize: function initialize(next) {

      hook.initialize(function () {
        sails.emit(&#x27;hook:&#x27; + hook.name + &#x27;:initialized&#x27;);
        next();
      });
    }
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>










</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sails-permissions.Passport" id="apidoc.module.sails-permissions.Passport">module sails-permissions.Passport</a></h1>




    <h2>
        <a href="#apidoc.element.sails-permissions.Passport.beforeCreate" id="apidoc.element.sails-permissions.Passport.beforeCreate">
        function <span class="apidocSignatureSpan">sails-permissions.Passport.</span>beforeCreate
        <span class="apidocSignatureSpan">(passport, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">beforeCreate = function (passport, next) {
  hashPassword(passport, next);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.Passport.beforeUpdate" id="apidoc.element.sails-permissions.Passport.beforeUpdate">
        function <span class="apidocSignatureSpan">sails-permissions.Passport.</span>beforeUpdate
        <span class="apidocSignatureSpan">(passport, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">beforeUpdate = function (passport, next) {
  hashPassword(passport, next);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sails-permissions.PermissionService" id="apidoc.module.sails-permissions.PermissionService">module sails-permissions.PermissionService</a></h1>


    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.addUsersToRole" id="apidoc.element.sails-permissions.PermissionService.addUsersToRole">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>addUsersToRole
        <span class="apidocSignatureSpan">(usernames, rolename)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">addUsersToRole = function (usernames, rolename) {
  if (_.isEmpty(usernames)) {
    return Promise.reject(new Error(&#x27;One or more usernames must be provided&#x27;));
  }

  if (!_.isArray(usernames)) {
    usernames = [usernames];
  }

  return Role.findOne({
    name: rolename
  }).populate(&#x27;users&#x27;).then(function(role) {
    return User.find({
      username: usernames
    }).then(function(users) {
      role.users.add(_.pluck(users, &#x27;id&#x27;));
      return role.save();
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.createRole" id="apidoc.element.sails-permissions.PermissionService.createRole">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>createRole
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">createRole = function (options) {

  var ok = Promise.resolve();
  var permissions = options.permissions;

  if (!_.isArray(permissions)) {
    permissions = [permissions];
  }


  // look up the model id based on the model name for each permission, and change it to an id
  ok = ok.then(function() {
    return Promise.all(permissions.map(function(permission) {
      return Model.findOne({
          name: permission.model
        })
        .then(function(model) {
          permission.model = model.id;
          return permission;
        });
    }));
  });

  // look up user ids based on usernames, and replace the names with ids
  ok = ok.then(function(permissions) {
    if (options.users) {
      return User.find({
          username: options.users
        })
        .then(function(users) {
          options.users = users;
        });
    }
  });

  ok = ok.then(function(users) {
    return Role.create(options);
  });

  return ok;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.findModelPermissions" id="apidoc.element.sails-permissions.PermissionService.findModelPermissions">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>findModelPermissions
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">findModelPermissions = function (options) {
  var action = PermissionService.getMethod(options.method);

  //console.log(&#x27;findModelPermissions options&#x27;, options)
  //console.log(&#x27;findModelPermissions action&#x27;, action)

  return User.findOne(options.user.id)
    .populate(&#x27;roles&#x27;)
    .then(function(user) {
      var permissionCriteria = {
        model: options.model.id,
        action: action,
        or: [
          { role: _.pluck(user.roles, &#x27;id&#x27;) },
          { user: user.id }
        ]
      };

      return Permission.find(permissionCriteria).populate(&#x27;criteria&#x27;)
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  };

  if (req.options.unknownModel) {
    return next();
  }

  PermissionService
    .<span class="apidocCodeKeywordSpan">findModelPermissions</span>(options)
    .then(function (permissions) {
sails.log.silly(&#x27;PermissionPolicy:&#x27;, permissions.length, &#x27;permissions grant&#x27;,
    req.method, &#x27;on&#x27;, req.model.name, &#x27;for&#x27;, req.user.username);

if (!permissions || permissions.length === 0) {
  return res.send(403, { error: PermissionService.getErrorMessage(options) });
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.findTargetObjects" id="apidoc.element.sails-permissions.PermissionService.findTargetObjects">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>findTargetObjects
        <span class="apidocSignatureSpan">(req)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">findTargetObjects = function (req) {


  // handle add/remove routes that have :parentid as the primary key field
  var originalId;
  if (req.params.parentid) {
    originalId = req.params.id;
    req.params.id = req.params.parentid;
  }

  return new Promise(function(resolve, reject) {
      sails.hooks.blueprints.middleware.find(req, {
        ok: resolve,
        serverError: reject,
        // this isn&#x27;t perfect, since it returns a 500 error instead of a 404 error
        // but it is better than crashing the app when a record doesn&#x27;t exist
        notFound: reject
      });
    })
    .then(function(result) {
      if (originalId !== undefined) {
        req.params.id = originalId;
      }
      return result;
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

    if (criteria.length) {
bindResponsePolicy(req, res, criteria);
    }
    return next();
  }

  PermissionService.<span class="apidocCodeKeywordSpan">findTargetObjects</span>(req)
    .then(function(objects) {

// attributes are not important for a delete request
if (action === &#x27;delete&#x27;) {
  body = undefined;
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.getErrorMessage" id="apidoc.element.sails-permissions.PermissionService.getErrorMessage">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>getErrorMessage
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getErrorMessage = function (options) {
  var user = options.user.email || options.user.username
  return [
    &#x27;User&#x27;, user, &#x27;is not permitted to&#x27;, options.method, options.model.name
  ].join(&#x27; &#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  PermissionService
    .findModelPermissions(options)
    .then(function (permissions) {
      sails.log.silly(&#x27;PermissionPolicy:&#x27;, permissions.length, &#x27;permissions grant&#x27;,
          req.method, &#x27;on&#x27;, req.model.name, &#x27;for&#x27;, req.user.username);

      if (!permissions || permissions.length === 0) {
        return res.send(403, { error: PermissionService.<span class="apidocCodeKeywordSpan">getErrorMessage</span>(options) });
      }

      req.permissions = permissions;

      next();
    });
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.getMethod" id="apidoc.element.sails-permissions.PermissionService.getMethod">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>getMethod
        <span class="apidocSignatureSpan">(method)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getMethod = function (method) {
  return methodMap[method];
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
module.exports = function(req, res, next) {
var permissions = req.permissions;

if (_.isEmpty(permissions)) {
  return next();
}

var action = PermissionService.<span class="apidocCodeKeywordSpan">getMethod</span>(req.method);

var body = req.body || req.query;

// if we are creating, we don&#x27;t need to query the db, just check the where clause vs the passed in data
if (action === &#x27;create&#x27;) {
  if (!PermissionService.hasPassingCriteria(body, permissions, body)) {
    return res.send(403, {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.grant" id="apidoc.element.sails-permissions.PermissionService.grant">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>grant
        <span class="apidocSignatureSpan">(permissions)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">grant = function (permissions) {
  if (!_.isArray(permissions)) {
    permissions = [permissions];
  }

  // look up the models based on name, and replace them with ids
  var ok = Promise.all(permissions.map(function(permission) {
    var findRole = permission.role ? Role.findOne({
      name: permission.role
    }) : null;
    var findUser = permission.user ? User.findOne({
      username: permission.user
    }) : null;
    return Promise.all([findRole, findUser, Model.findOne({
        name: permission.model
      })])
      .then(([ role, user, model]) =&#x3e; {
        permission.model = model.id;
        if (role &#x26;&#x26; role.id) {
          permission.role = role.id;
        } else if (user &#x26;&#x26; user.id) {
          permission.user = user.id;
        } else {
          return Promise.reject(new Error(&#x27;no role or user specified&#x27;));
        }
      });
  }));

  ok = ok.then(function() {
    return Permission.create(permissions);
  });

  return ok;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.hasForeignObjects" id="apidoc.element.sails-permissions.PermissionService.hasForeignObjects">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>hasForeignObjects
        <span class="apidocSignatureSpan">(objects, user)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">hasForeignObjects = function (objects, user) {
  if (!_.isArray(objects)) {
    return PermissionService.isForeignObject(user.id)(objects);
  }
  return _.any(objects, PermissionService.isForeignObject(user.id));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    .then(function(objects) {
  // PermissionService.isAllowedToPerformAction checks if the user has &#x27;user&#x27; based permissions (vs role or owner based
 permissions)
return PermissionService.isAllowedToPerformAction(objects, req.user, action, ModelService.getTargetModelName(req), req.body)
  .then(function(hasUserPermissions) {
    if (hasUserPermissions) {
      return next();
    }
    if (PermissionService.<span class="apidocCodeKeywordSpan">hasForeignObjects</span>(objects, req.user)) {
      return res.send(403, {
        error: &#x27;Cannot perform action [&#x27; + action + &#x27;] on foreign object&#x27;
      });
    }
    next();
  });
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.hasOwnershipPolicy" id="apidoc.element.sails-permissions.PermissionService.hasOwnershipPolicy">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>hasOwnershipPolicy
        <span class="apidocSignatureSpan">(model)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">hasOwnershipPolicy = function (model) {
  return model.autoCreatedBy;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.hasPassingCriteria" id="apidoc.element.sails-permissions.PermissionService.hasPassingCriteria">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>hasPassingCriteria
        <span class="apidocSignatureSpan">(objects, permissions, attributes, user)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">hasPassingCriteria = function (objects, permissions, attributes, user) {
  // return success if there are no permissions or objects
  if (_.isEmpty(permissions) || _.isEmpty(objects)) return true;

  if (!_.isArray(objects)) {
    objects = [objects];
  }

  var criteria = permissions.reduce(function (memo, perm) {
    if (perm) {
      if (!perm.criteria || perm.criteria.length==0) {
        // If a permission has no criteria then it passes for all cases
        // (like the admin role)
        memo = memo.concat([{where:{}}]);
      }
      else {
          memo = memo.concat(perm.criteria);
      }
      if (perm.relation === &#x27;owner&#x27;) {
          perm.criteria.forEach(function (criteria) {
              criteria.owner = true;
          });
      }
      return memo;
    }
  }, []);


  if (!_.isArray(criteria)) {
    criteria = [criteria];
  }

  if (_.isEmpty(criteria)) {
    return true;
  }

  // every object must have at least one permission that has a passing criteria and a passing attribute check
  return objects.every(function(obj) {
    return criteria.some(function(criteria) {
      var match = wlFilter([obj], {
        where: criteria.where
      }).results;
      var hasUnpermittedAttributes = PermissionService.hasUnpermittedAttributes(attributes, criteria.blacklist);
      var hasOwnership = true; // edge case for scenario where a user has some permissions that are owner based and some that are
 role based
      if (criteria.owner) {
        hasOwnership = !PermissionService.isForeignObject(user)(obj);
      }
      return match.length === 1 &#x26;&#x26; !hasUnpermittedAttributes &#x26;&#x26; hasOwnership;
    });
  });

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var action = PermissionService.getMethod(req.method);

var body = req.body || req.query;

// if we are creating, we don&#x27;t need to query the db, just check the where clause vs the passed in data
if (action === &#x27;create&#x27;) {
  if (!PermissionService.<span class="apidocCodeKeywordSpan">hasPassingCriteria</span>(body, permissions, body)) {
    return res.send(403, {
      error: &#x27;Can\&#x27;t create this object, because of failing where clause&#x27;
    });
  }
  return next();
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.hasUnpermittedAttributes" id="apidoc.element.sails-permissions.PermissionService.hasUnpermittedAttributes">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>hasUnpermittedAttributes
        <span class="apidocSignatureSpan">(attributes, blacklist)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">hasUnpermittedAttributes = function (attributes, blacklist) {
  if (_.isEmpty(attributes) || _.isEmpty(blacklist)) {
    return false;
  }
  return _.intersection(Object.keys(attributes), blacklist).length ? true : false;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// every object must have at least one permission that has a passing criteria and a passing attribute check
return objects.every(function(obj) {
  return criteria.some(function(criteria) {
    var match = wlFilter([obj], {
      where: criteria.where
    }).results;
    var hasUnpermittedAttributes = PermissionService.<span class="apidocCodeKeywordSpan">hasUnpermittedAttributes</span>(attributes
, criteria.blacklist);
    var hasOwnership = true; // edge case for scenario where a user has some permissions that are owner based and some that are
role based
    if (criteria.owner) {
      hasOwnership = !PermissionService.isForeignObject(user)(obj);
    }
    return match.length === 1 &#x26;&#x26; !hasUnpermittedAttributes &#x26;&#x26; hasOwnership;
  });
});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.isAllowedToPerformAction" id="apidoc.element.sails-permissions.PermissionService.isAllowedToPerformAction">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>isAllowedToPerformAction
        <span class="apidocSignatureSpan">(objects, user, action, model, body)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">isAllowedToPerformAction = function (objects, user, action, model, body) {
  if (!_.isArray(objects)) {
    return PermissionService.isAllowedToPerformSingle(user.id, action, model, body)(objects);
  }
  return Promise.all(objects.map(PermissionService.isAllowedToPerformSingle(user.id, action, model, body)))
    .then(function (allowedArray) {
      return allowedArray.every(function (allowed) {
        return allowed === true;
      });
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  req.query.owner = req.user.id;
  _.isObject(req.body) &#x26;&#x26; (req.body.owner = req.user.id);
}

PermissionService.findTargetObjects(req)
  .then(function(objects) {
      // PermissionService.isAllowedToPerformAction checks if the user has &#x27;user&#x27; based permissions (vs role or owner
based permissions)
    return PermissionService.<span class="apidocCodeKeywordSpan">isAllowedToPerformAction</span>(objects, req.user, action, ModelService
.getTargetModelName(req), req.body)
      .then(function(hasUserPermissions) {
        if (hasUserPermissions) {
          return next();
        }
        if (PermissionService.hasForeignObjects(objects, req.user)) {
          return res.send(403, {
            error: &#x27;Cannot perform action [&#x27; + action + &#x27;] on foreign object&#x27;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.isAllowedToPerformSingle" id="apidoc.element.sails-permissions.PermissionService.isAllowedToPerformSingle">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>isAllowedToPerformSingle
        <span class="apidocSignatureSpan">(user, action, model, body)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">isAllowedToPerformSingle = function (user, action, model, body) {
  return function(obj) {
    return new Promise(function(resolve, reject) {
      Model.findOne({
        identity: model
      }).then(function(model) {
       return Permission.find({
          model: model.id,
          action: action,
          relation: &#x27;user&#x27;,
          user: user
        }).populate(&#x27;criteria&#x27;);
      }).then(function(permission) {
        if (permission.length &#x3e; 0 &#x26;&#x26; PermissionService.hasPassingCriteria(obj, permission, body)) {
          resolve(true);
        } else {
          resolve(false);
        }
      }).catch(reject);
    });
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * @param action
 * @param model
 * @param body
 * @returns {*}
 */
isAllowedToPerformAction: function(objects, user, action, model, body) {
  if (!_.isArray(objects)) {
    return PermissionService.<span class="apidocCodeKeywordSpan">isAllowedToPerformSingle</span>(user.id, action, model, body)(objects
);
  }
  return Promise.all(objects.map(PermissionService.isAllowedToPerformSingle(user.id, action, model, body)))
    .then(function (allowedArray) {
      return allowedArray.every(function (allowed) {
        return allowed === true;
      });
    });
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.isForeignObject" id="apidoc.element.sails-permissions.PermissionService.isForeignObject">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>isForeignObject
        <span class="apidocSignatureSpan">(owner)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">isForeignObject = function (owner) {
  return function(object) {
    //sails.log.verbose(&#x27;object&#x27;, object);
    //sails.log.verbose(&#x27;object.owner: &#x27;, object.owner, &#x27;, owner:&#x27;, owner);
    return object.owner !== owner;
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

/**
 * Given an object, or a list of objects, return true if the list contains
 * objects not owned by the specified user.
 */
hasForeignObjects: function(objects, user) {
  if (!_.isArray(objects)) {
    return PermissionService.<span class="apidocCodeKeywordSpan">isForeignObject</span>(user.id)(objects);
  }
  return _.any(objects, PermissionService.isForeignObject(user.id));
},

/**
 * Return whether the specified object is NOT owned by the specified user.
 */
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.removeUsersFromRole" id="apidoc.element.sails-permissions.PermissionService.removeUsersFromRole">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>removeUsersFromRole
        <span class="apidocSignatureSpan">(usernames, rolename)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">removeUsersFromRole = function (usernames, rolename) {
  if (_.isEmpty(usernames)) {
    return Promise.reject(new Error(&#x27;One or more usernames must be provided&#x27;));
  }

  if (!_.isArray(usernames)) {
    usernames = [usernames];
  }

  return Role.findOne({
      name: rolename
    })
    .populate(&#x27;users&#x27;)
    .then(function(role) {
      return User.find({
        username: usernames
      }, {
        select: [&#x27;id&#x27;]
      }).then(function(users) {
        users.map(function(user) {
          role.users.remove(user.id);
        });
        return role.save();
      });
    });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.PermissionService.revoke" id="apidoc.element.sails-permissions.PermissionService.revoke">
        function <span class="apidocSignatureSpan">sails-permissions.PermissionService.</span>revoke
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">revoke = function (options) {
  var findRole = options.role ? Role.findOne({
    name: options.role
  }) : null;
  var findUser = options.user ? User.findOne({
    username: options.user
  }) : null;
  var ok = Promise.all([findRole, findUser, Model.findOne({
    name: options.model
  })]);

  ok = ok.then(([ role, user, model ]) =&#x3e; {

    var query = {
      model: model.id,
      action: options.action,
      relation: options.relation
    };

    if (role &#x26;&#x26; role.id) {
      query.role = role.id;
    } else if (user &#x26;&#x26; user.id) {
      query.user = user.id;
    } else {
      return Promise.reject(new Error(&#x27;You must provide either a user or role to revoke the permission from&#x27;));
    }

    return Permission.destroy(query);
  });

  return ok;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sails-permissions.User" id="apidoc.module.sails-permissions.User">module sails-permissions.User</a></h1>


    <h2>
        <a href="#apidoc.element.sails-permissions.User.beforeCreate" id="apidoc.element.sails-permissions.User.beforeCreate">
        function <span class="apidocSignatureSpan">sails-permissions.User.</span>beforeCreate
        <span class="apidocSignatureSpan">(user, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">beforeCreate = function (user, next) {
  if (_.isEmpty(user.username)) {
    user.username = user.email;
  }
  next();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sails-permissions.User.register" id="apidoc.element.sails-permissions.User.register">
        function <span class="apidocSignatureSpan">sails-permissions.User.</span>register
        <span class="apidocSignatureSpan">(user)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">register = function (user) {
  return new Promise(function (resolve, reject) {
    sails.services.passport.protocols.local.createUser(user, function (error, created) {
      if (error) return reject(error);

      resolve(created);
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>






</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sails-permissions.generator" id="apidoc.module.sails-permissions.generator">module sails-permissions.generator</a></h1>


    <h2>
        <a href="#apidoc.element.sails-permissions.generator.before" id="apidoc.element.sails-permissions.generator.before">
        function <span class="apidocSignatureSpan">sails-permissions.generator.</span>before
        <span class="apidocSignatureSpan">(scope, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">before = function (scope, next) {
  scope.module = options.module;
  scope.id = options.id;
  scope.createdAt = new Date();

  next();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>






</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
